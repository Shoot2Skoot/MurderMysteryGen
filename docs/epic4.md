# Epic 4: Structured Data Output & Orchestration Finalization

**Goal:** Ensure all generated mystery components (victim, suspects with original/modified MMOs, killer, evidence) are correctly aggregated and formatted into a final, well-structured JSON output. Finalize and test the end-to-end agent orchestration for a complete generation run.

**Deployability:** This epic represented the culmination of the MVP's core generation pipeline. All data generated in previous epics is correctly assembled into the final `CaseContext`. The main script (`src/mystery_ai/main.py`) now executes the full pipeline and saves the complete mystery data to a uniquely named JSON file in the `generated_mysteries/` directory. This is the primary deliverable of the MVP.

## Epic-Specific Technical Context

- **Final Pydantic Model (`CaseContext`):** The `CaseContext` model in `core/data_models.py` is complete and includes all elements: theme, victim, suspects (with profiles, original/modified MMOs, killer status), and evidence items.
- **JSON Serialization:** `main_orchestrator.py` uses `case_context.model_dump_json(indent=2)` to serialize the final `CaseContext` and writes it to a file. Helper functions for ensuring output directory and generating filenames are implemented.
- **End-to-End Script:** `src/mystery_ai/main.py` (calling `orchestration/main_orchestrator.py`) orchestrates the full sequence of agent logic from Epics 1, 2, and 3, followed by file output.
- **Schema Documentation:** `docs/data-models.md` has been updated with the full JSON schema for `CaseContext` as generated by `CaseContext.model_json_schema()`.

## Local Testability & Command-Line Access

- **Local Development:** Developers run `python -m src.mystery_ai.main --theme "Your Theme"` from the `MurderMysteryGen` root directory to execute the entire MVP pipeline.
- **Output:** The script produces a uniquely named JSON file in `generated_mysteries/` and also prints the JSON to the console.
- **Verification:** Successful MVP completion is verified by: 
    1. Script running without errors.
    2. Creation of the JSON output file.
    3. Manual inspection of the JSON file content for completeness and coherence of all generated mystery elements (victim, suspects, killer, MMOs, evidence) against the input theme.
    4. Programmatic validation of the JSON output against the schema in `data-models.md` (as part of `testing-strategy.md` future automated tests).

## Story List

### Story 4.1: Finalize `CaseContext` Pydantic Model & Aggregation Logic

- **User Story / Goal:** As a Developer, I need to ensure the main `CaseContext` Pydantic model accurately reflects all data elements generated throughout the pipeline and that there's clear logic for aggregating all components into this final model.
- **Detailed Requirements:** Implemented and reviewed through Epics 1-3 integration. `CaseContext` in `core/data_models.py` is finalized for MVP.
- **Acceptance Criteria (ACs):**
  - AC1: The `CaseContext` Pydantic model is complete and accurately represents the full mystery data structure. **(COMPLETED)**
  - AC2: The orchestration logic correctly populates a single `CaseContext` instance. **(COMPLETED)**
  - AC3: All sub-models are correctly nested or referenced. **(COMPLETED)**
- **Dependencies:** Story 1.5, Story 2.3, Story 3.3.
- **Status:** COMPLETED

---

### Story 4.2: Implement JSON Output Generation

- **User Story / Goal:** As a Developer, I want the system to serialize the final `CaseContext` object into a well-formatted JSON string and save it to a file.
- **Detailed Requirements:** Implemented in `main_orchestrator.py` with helper functions for directory and filename.
- **Acceptance Criteria (ACs):**
  - AC1: A JSON file is created in `generated_mysteries/`. **(COMPLETED)**
  - AC2: The content is a valid JSON representation of `CaseContext`. **(COMPLETED)**
  - AC3: The JSON is well-formatted (indented). **(COMPLETED)**
  - AC4: Filename includes theme and timestamp. **(COMPLETED)**
- **Dependencies:** Story 4.1.
- **Status:** COMPLETED

---

### Story 4.3: Document Output Schema in `data-models.md`

- **User Story / Goal:** As a Developer, I need to document the schema of the output JSON file in `docs/data-models.md`.
- **Detailed Requirements:** `tools/generate_schema.py` created and used to update `data-models.md` with the `CaseContext` JSON schema.
- **Acceptance Criteria (ACs):**
  - AC1: `docs/data-models.md` contains the `CaseContext` JSON schema. **(COMPLETED)**
  - AC2: The documented schema accurately reflects the `CaseContext` Pydantic model. **(COMPLETED)**
  - AC3: Descriptions for key fields are provided via schema generation. **(COMPLETED)**
- **Dependencies:** Story 4.1.
- **Status:** COMPLETED

---

### Story 4.4: Implement End-to-End Orchestration Script & Testing

- **User Story / Goal:** As a Developer, I want a main script that runs the entire mystery generation pipeline from theme input to JSON file output, allowing for end-to-end testing of the MVP.
- **Detailed Requirements:** `src/mystery_ai/main.py` and `src/mystery_ai/orchestration/main_orchestrator.py` provide this functionality. Final review of logging completed.
- **Acceptance Criteria (ACs):**
  - AC1: A single script (`python -m src.mystery_ai.main`) runs the entire pipeline. **(COMPLETED)**
  - AC2: The script accepts a theme via CLI argument. **(COMPLETED)**
  - AC3: Upon successful execution, a JSON output file is created. **(COMPLETED)**
  - AC4: The script runs without unhandled exceptions for valid inputs. **(COMPLETED)**
  - AC5: Console logs indicate progress through major stages. **(COMPLETED)**
- **Dependencies:** Story 1.6, Story 2.4, Story 3.4, Story 4.2.
- **Status:** COMPLETED

## Change Log

| Change | Date | Version | Description | Author |
| ------ | ---- | ------- | ----------- | ------ |
|        |      | 0.1     | Initial draft of Epic 4 | PM Agent |
|        |      | 0.2     | Stories 4.1-4.4 completed. MVP generation pipeline is functional. | Dev Agent |
|        |      | 0.3     | Finalized documentation for Epic 4 reflecting its completed state. | Architect Agent | 