# Story 6.2: Orchestrate `PreInitializationIdeationAgent` Call

**Status:** Review

## Goal & Context

**User Story:** As a Developer, I want to integrate the `PreInitializationIdeationAgent` into the main orchestration flow so that thematic name lists are generated early in the process.

**Context:** This story follows the creation of the `PreInitializationIdeationAgent` in Story 6.1. Now, the `main_orchestrator.py` needs to be updated to call this new agent. This call should happen early in the process, right after the theme is established, to generate thematic name lists. These lists will then be available for other agents like `CaseInitializationAgent` and `SuspectGenerationAgent` to use for naming characters.

## Detailed Requirements

- In `src/mystery_ai/main_orchestrator.py`, modify the orchestration logic.
- After the main theme for the mystery is determined/inputted, instantiate and run the `PreInitializationIdeationAgent` (created in Story 6.1), passing the theme to it.
- Retrieve the output from the `PreInitializationIdeationAgent` (which should be a `ThematicNameLists` object or similar).
- Extract the list of first names and the list of last names from the agent's output.
- Store or prepare these lists in a way that they can be passed as input to `CaseInitializationAgent` (Story 6.3) and `SuspectGenerationAgent` (Story 6.4). This might involve:
    - Adding them to a dictionary that's passed along the orchestration chain.
    - Temporarily adding them to the `CaseContext` Pydantic model if that's the primary carrier of state between agent calls (consider if this is the cleanest approach or if direct passing is better).

## Acceptance Criteria (ACs)

- AC1: The `main_orchestrator.py` successfully calls the `PreInitializationIdeationAgent`, providing the current theme as input.
- AC2: The orchestrator correctly extracts the `first_names` list and `last_names` list from the `PreInitializationIdeationAgent`'s structured output.
- AC3: The extracted lists of names are made available (e.g., logged for now, or passed into a data structure that subsequent agents will access) for use by `CaseInitializationAgent` and `SuspectGenerationAgent`.

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Developer agent is expected to follow project standards in `docs/coding-standards.md` and understand the project structure in `docs/project-structure.md`.

- **Relevant Files:**
  - Files to Create: None.
  - Files to Modify:
    - `src/mystery_ai/main_orchestrator.py`
    - Potentially `src/mystery_ai/core/data_models.py` if `CaseContext` is updated to hold the name lists.

- **Key Technologies:**
  - Python.
  - OpenAI Agents SDK (for running agents via `Runner.run_sync` or similar).

- **API Interactions / SDK Usage:**
  - Importing and running the `PreInitializationIdeationAgent`.
  - Handling the structured output (Pydantic model) from the agent.

- **UI/UX Notes:**
  - N/A

- **Data Structures:**
  - Input: Theme string.
  - Output from `PreInitializationIdeationAgent`: `ThematicNameLists` object.
  - Data to pass to subsequent agents: The two lists of names (`List[str]`).

- **Environment Variables:**
  - None specific to this story beyond what's needed for agent execution.

- **Coding Standards Notes:**
  - Follow standards in `docs/coding-standards.md`.
  - Ensure the new agent call is placed logically within the existing orchestration flow (i.e., after theme is known, before victim/suspect generation).
  - Error handling around the agent call (e.g., if the agent fails or returns unexpected data) should be considered.

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests. Follow general testing approach in `docs/testing-strategy.md`.

- **Unit Tests:**
  - If complex logic is introduced in the orchestrator for handling/storing the name lists, it could be unit tested.
- **Integration Tests:**
  - Run the `main_orchestrator.py` (or the relevant part of it) with a test theme.
  - Verify that `PreInitializationIdeationAgent` is called.
  - Verify that the orchestrator successfully retrieves the name lists from the agent's output (e.g., by logging them).
- **Manual/CLI Verification:**
  - Add logging in `main_orchestrator.py` to print the theme being passed to the agent and the lists of names received from it.
  - Run `python -m src.mystery_ai.main --theme "Your Test Theme"` and check the logs.

## Tasks / Subtasks

- [x] Task 1: In `main_orchestrator.py`, import the `PreInitializationIdeationAgent` and its output model (e.g., `ThematicNameLists`).
- [x] Task 2: Identify the point in the orchestration flow where the theme is finalized.
- [x] Task 3: After the theme is known, add logic to instantiate `PreInitializationIdeationAgent`.
- [x] Task 4: Call the agent with the theme as input (e.g., using `Runner.run_sync`).
- [x] Task 5: Handle the agent's result, expecting a `ThematicNameLists` object.
- [x] Task 6: Extract `first_names` and `last_names` lists from the result.
- [x] Task 7: Add logging to display the retrieved lists.
- [x] Task 8: (Decision Point) Decide how to pass these lists to subsequent agents (e.g., as part of an input dictionary for `CaseInitializationAgent` or via `CaseContext`). Implement the chosen method for preparing this data.
  - **Decision:** The lists will be stored in `CaseContext` and also passed directly to `CaseInitializationAgent` and `SuspectGenerationAgent` as part of their input dictionary.
- [x] Task 9: Test the updated orchestration to ensure the agent is called and lists are retrieved (AC1, AC2, AC3).
- [x] Task 10: Verify all Acceptance Criteria are met.
  - AC1: The `main_orchestrator.py` successfully calls the `PreInitializationIdeationAgent`, providing the current theme as input. (Verified)
  - AC2: The orchestrator correctly extracts the `first_names` list and `last_names` list from the `PreInitializationIdeationAgent`'s structured output. (Verified)
  - AC3: The extracted lists of names are made available for use by `CaseInitializationAgent` and `SuspectGenerationAgent`. (Verified - Added to CaseContext and passed in agent inputs)

## Story Wrap Up (Agent Populates After Execution)

- **Agent Model Used:** `Claude 3.7 Sonnet (via Cursor)`
- **Completion Notes:** The `PreInitializationIdeationAgent` has been successfully integrated into the main orchestration flow. The agent is called right after the theme is established, and the generated name lists are stored in the `CaseContext` model. The name lists are also passed directly to the `CaseInitializationAgent` and `SuspectGenerationAgent` as part of their input dictionaries. Error handling has been implemented to allow the pipeline to continue even if the name generation fails, with appropriate warning logs. The decision was made to both store the name lists in the `CaseContext` (for persistence) and pass them directly to subsequent agents (for immediate use).
- **Change Log:**
  - Initial Draft
  - Updated CaseContext model to include thematic_first_names and thematic_last_names
  - Added PreInitializationIdeationAgent call at the beginning of the orchestration pipeline
  - Implemented extraction and storage of name lists
  - Added passing of name lists to subsequent agents
  - Added error handling and logging
  - Updated story status to Review 