# Story 8.1: Finalize Orchestration Flow for Phase 2 Features

**Status:** Draft

## Goal & Context

**User Story:** As a Developer, I want to ensure the `main_orchestrator.py` correctly and robustly sequences all agent calls and data handoffs for the new diversity and evidence crafting features developed in Phase 2 (Epics 5, 6, and 7).

**Context:** This story is the first step in Epic 8, which is the capstone epic for Phase 2. It focuses on the `main_orchestrator.py` script, ensuring that all the new agents and modifications to existing agents from Epics 5 (Static Attribute Lists), 6 (Dynamic Name Generation), and 7 (Advanced Evidence Crafting) are correctly integrated, called in the right order, and that data flows between them as intended.

## Detailed Requirements

- Thoroughly review the existing `main_orchestrator.py` logic.
- **Sequence Verification:**
    - Confirm loading of master attribute lists (Story 5.1) and evidence category lists (Story 7.1).
    - Confirm `PreInitializationIdeationAgent` (Story 6.1) is called after theme establishment and its output (name lists) is correctly captured (Story 6.2).
    - Confirm orchestrator logic for selecting attribute sub-lists (Story 5.2) and evidence category options (Story 7.4) is in place before relevant agent calls.
    - Confirm `CaseInitializationAgent` is called with theme, selected attribute options (from Story 5.2), and thematic name lists (from Story 6.2), and integrates them (Story 5.3, 6.3).
    - Confirm `SuspectGenerationAgent` is called with theme, victim profile, attribute options (if any apply to suspects), thematic name lists (Story 6.2), and integrates names (Story 6.4).
    - Confirm `EvidenceGenerationAgent` is called for each suspect with relevant context and the evidence category options (Story 7.4), and integrates these into evidence items (Story 7.3).
- **Data Flow Verification:**
    - Ensure data (master lists, sub-selected options, generated name lists, theme, victim/suspect profiles) is correctly passed as input to each agent at the appropriate stage.
    - Verify that the `CaseContext` object (or any intermediate data structures) correctly accumulates data as the orchestration progresses.
- **Error Handling:**
    - Review and implement basic error handling for new agent calls (e.g., if an agent fails to return expected data). This could involve logging errors and deciding if the process can continue gracefully or should halt. More sophisticated error handling can be deferred, but basic resilience is needed.
- **Refactoring (if needed):**
    - Refactor sections of `main_orchestrator.py` for clarity, efficiency, or better organization related to Phase 2 feature integration.

## Acceptance Criteria (ACs)

- AC1: All agent calls related to Epics 5, 6, and 7 are present in `main_orchestrator.py` and executed in the correct logical sequence.
- AC2: All necessary data inputs (e.g., theme, master lists, sub-selected options, generated name lists, intermediate agent outputs) are correctly passed to each relevant agent.
- AC3: The orchestration flow demonstrates resilience to basic, expected issues, such as an agent call failing or returning an empty list where appropriate, by logging the issue and potentially having a defined fallback or stop. (Full-scale error recovery is beyond this story).
- AC4: The final `CaseContext` produced by the orchestrator contains all data elements expected from the successful execution of Phase 2 features.

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Developer agent is expected to follow project standards in `docs/coding-standards.md` and understand the project structure in `docs/project-structure.md`.

- **Relevant Files:**
  - Files to Create: None.
  - Files to Modify:
    - `src/mystery_ai/main_orchestrator.py`

- **Key Technologies:**
  - Python.

- **API Interactions / SDK Usage:**
  - Invoking various agents using the OpenAI Agents SDK's `Runner`.

- **UI/UX Notes:**
  - N/A

- **Data Structures:**
  - Heavy interaction with `CaseContext` and individual Pydantic models for agent inputs/outputs.

- **Environment Variables:**
  - None specific to this story beyond general agent execution needs.

- **Coding Standards Notes:**
  - Emphasize clarity and maintainability in the orchestrator logic.
  - Add comments to explain complex data handoffs or decision points related to Phase 2 features.
  - Ensure logging is sufficient to trace the flow of new data elements.

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests.

- **Integration Tests (Orchestrator Level):**
  - Run the full `main_orchestrator.py` script (`python -m src.mystery_ai.main --theme "..."`) with several diverse themes.
  - Use logging and/or a debugger to trace the execution flow and verify agent call sequence (AC1).
  - Inspect the inputs passed to each agent call to confirm correctness (AC2).
  - (If error conditions are testable) Introduce controlled failures (e.g., mock an agent to return an error or unexpected data) to observe orchestrator resilience (AC3).
- **Manual/CLI Verification:**
  - Examine the final JSON output in `generated_mysteries/` to ensure it reflects a complete run with Phase 2 data (implicitly tests AC4 at a high level, detailed in Story 8.4).
  - Review logs for correct sequencing and data handoff messages.

## Tasks / Subtasks

- [ ] Task 1: Review `main_orchestrator.py` against the requirements of Epics 5, 6, and 7 to map out all required agent calls and data dependencies.
- [ ] Task 2: Verify/implement loading of master attribute lists (Story 5.1) and evidence category lists (Story 7.1).
- [ ] Task 3: Verify/implement call to `PreInitializationIdeationAgent`, capture of name lists (Story 6.1, 6.2).
- [ ] Task 4: Verify/implement logic for selecting attribute sub-lists (Story 5.2).
- [ ] Task 5: Verify/implement logic for selecting evidence category options (Story 7.4).
- [ ] Task 6: Verify/update call to `CaseInitializationAgent` with all required Phase 2 inputs (attribute options, name lists).
- [ ] Task 7: Verify/update call(s) to `SuspectGenerationAgent` with all required Phase 2 inputs (name lists, possibly attribute options).
- [ ] Task 8: Verify/update call(s) to `EvidenceGenerationAgent` with evidence category options.
- [ ] Task 9: Review and implement basic error handling (e.g., try-except blocks, logging) for new agent interactions.
- [ ] Task 10: Refactor orchestrator code for Phase 2 features if clarity or organization can be improved.
- [ ] Task 11: Conduct integration tests by running the full pipeline with logging to verify AC1, AC2.
- [ ] Task 12: Verify all Acceptance Criteria are met.

## Story Wrap Up (Agent Populates After Execution)

- **Agent Model Used:** `<Agent Model Name/Version>`
- **Completion Notes:** {Detail any significant refactoring done, or specific error handling strategies implemented.}
- **Change Log:**
  - Initial Draft 