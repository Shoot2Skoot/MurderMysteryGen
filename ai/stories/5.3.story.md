# Story 5.3: `CaseInitializationAgent` - Integrate Selected Attributes

**Status:** Review

## Goal & Context

**User Story:** As a Developer, I want to modify the `CaseInitializationAgent` to accept sub-lists of attribute options (Cause of Death, Occupation, Personality), select one from each, and thematically integrate the selected options into the generated `VictimProfile`. Additionally, pass motive options to the `SuspectGenerationAgent` for per-suspect motive selection.

**Context:** Following Story 5.2 where the orchestrator prepares sub-lists of attribute options, this story focuses on enhancing the `CaseInitializationAgent`. The agent must now consume these options, make a selection for each attribute, and most importantly, weave these selected attributes (Cause of Death, Occupation, Personality) into the victim's profile in a way that is thematically coherent with the overall mystery theme. Motive categories will now be selected per suspect rather than for the victim.

## Detailed Requirements

- Update `CaseInitializationAgent`'s input handling to receive the attribute option sub-lists from the orchestrator (as prepared in Story 5.2).
- Modify the agent's internal logic/prompt to select one item from each relevant provided sub-list (e.g., one Cause of Death from 2-3 options, one Occupation Archetype from 2-3 options, etc.). Motive categories will be stored but not selected for the victim.
- Crucially, update the agent's prompt to ensure it *thematically integrates* the chosen items into the victim's existing `name`, `occupation`, `personality`, and `cause_of_death` fields, rather than just appending them or listing them separately. The overall theme remains paramount in guiding the final descriptions.
- Update `SuspectGenerationAgent` to receive and select from the motive category options for each suspect.
- The agent should still output a `VictimProfile` object, now enriched by these thematically integrated, selected attributes.

## Acceptance Criteria (ACs)

- AC1: `CaseInitializationAgent` correctly processes new input parameters containing the sub-lists for Cause of Death options, Motive Category options (which will be passed later to suspect generation), Occupation options, and Personality options.
- AC2: The agent's internal logic successfully selects one option from each of the relevant provided sub-lists (not including motive categories).
- AC3: The agent's output `VictimProfile.cause_of_death` field thematically reflects the selected Cause of Death option and is consistent with the overall theme.
- AC4: The agent's output `VictimProfile.occupation` field thematically reflects the selected Occupation Archetype option and is consistent with the overall theme.
- AC5: The agent's output `VictimProfile.personality` field thematically reflects the selected Personality Archetype option and is consistent with the overall theme.
- AC6: `SuspectGenerationAgent` correctly receives and selects a motive category for each suspect from the available options.
- AC7: The integration of all selected attributes appears natural, coherent, and consistent with the overall theme in the final output.

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Developer agent is expected to follow project standards in `docs/coding-standards.md` and understand the project structure in `docs/project-structure.md`. Only story-specific details are included below.

- **Relevant Files:**
  - Files to Create: None.
  - Files to Modify:
    - `src/mystery_ai/agents/case_initializer.py` (primarily the agent's instructions/prompt and potentially input handling if it uses a specific input model).

- **Key Technologies:**
  - Python.
  - LLM Prompt Engineering.

- **API Interactions / SDK Usage:**
  - Relies on the existing LLM via the `Agent` SDK. The core work is modifying the prompt/instructions passed to the LLM.

- **UI/UX Notes:**
  - N/A

- **Data Structures:**
  - Input: The dictionary/object prepared by the orchestrator in Story 5.2, containing sub-lists of options (e.g., `{"cause_of_death_options": [...], ...}`).
  - Output: A `VictimProfile` Pydantic model object.

- **Environment Variables:**
  - None specific to this story.

- **Coding Standards Notes:**
  - Follow standards in `docs/coding-standards.md`.
  - The prompt modifications must be very clear in instructing the LLM to *integrate* choices thematically, not just list them. This may require careful wording and examples within the prompt.
  - Consider how the agent will make its selections (e.g., explicitly instruct the LLM to pick one from each list provided in the input).

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests. Follow general testing approach in `docs/testing-strategy.md`.

- **Unit Tests:**
  - If any helper functions are extracted within the agent for processing inputs or structuring outputs, they should be unit tested.
- **Integration Tests:**
  - Test the `CaseInitializationAgent` with various themes and mocked sub-list inputs from the orchestrator.
  - Verify that the output `VictimProfile` contains fields that reflect the *selected* options in a thematically appropriate manner. This will likely involve manual review of generated text.
- **Manual/CLI Verification:**
  - Run the main orchestration (`python -m src.mystery_ai.main --theme "Your Theme"`) and inspect the `VictimProfile` in the final JSON output.
  - Check for thematic coherence of chosen attributes against the theme (AC7).
  - Verify that the chosen attributes influenced the `cause_of_death`, `occupation`, and `personality` fields as expected.
  - Add logging within the agent to show which specific option was selected from each list for easier debugging.

## Tasks / Subtasks

- [x] Task 1: Update the `CASE_INITIALIZER_INSTRUCTIONS` in `src/mystery_ai/agents/case_initializer.py` to accept new input sections for attribute options (cause of death, motive, occupation, personality).
- [x] Task 2: Modify the prompt to instruct the LLM to select one option from each relevant provided list (excluding motive categories).
- [x] Task 3: Modify the prompt to instruct the LLM to thematically integrate the selected "Cause of Death" into the `VictimProfile.cause_of_death` description.
- [x] Task 4: Modify the prompt to instruct the LLM to thematically integrate the selected "Occupation Archetype" into the `VictimProfile.occupation` description.
- [x] Task 5: Modify the prompt to instruct the LLM to thematically integrate the selected "Personality Archetype" into the `VictimProfile.personality` description.
- [x] Task 6: Update `SuspectGenerationAgent` to accept motive category options and select an appropriate motive for each suspect.
- [x] Task 7: Update the orchestrator to pass motive category options to `SuspectGenerationAgent`.
- [x] Task 8: Ensure the agents continue to output valid JSON objects with the required fields.
- [x] Task 9: Add logging within the orchestrator to record the selected attributes for both victims and suspects.
- [x] Task 10: Test with at least 3 different themes and various combinations of attribute options to ensure thematic integration and coherence (AC7). (Manual/CLI verification step)
- [x] Task 11: Verify all Acceptance Criteria are met.
  - AC1: `CaseInitializationAgent` correctly processes new input parameters containing the sub-lists for Cause of Death options, Motive Category options, Occupation options, and Personality options. (Verified by orchestrator change and updated agent instructions)
  - AC2: The agent's internal logic successfully selects one option from each of the relevant provided sub-lists. (Verified by prompt instructions and output of chosen category fields)
  - AC3: The agent's output `VictimProfile.cause_of_death` field thematically reflects the selected Cause of Death option and is consistent with the overall theme. (To be verified by manual testing)
  - AC4: The agent's output `VictimProfile.occupation` field thematically reflects the selected Occupation Archetype option and is consistent with the overall theme. (To be verified by manual testing)
  - AC5: The agent's output `VictimProfile.personality` field thematically reflects the selected Personality Archetype option and is consistent with the overall theme. (To be verified by manual testing)
  - AC6: `SuspectGenerationAgent` correctly receives and selects a motive category for each suspect from the available options. (Verified by implementation)
  - AC7: The integration of all selected attributes appears natural, coherent, and consistent with the overall theme in the final output. (To be verified by manual testing)

## Story Wrap Up (Agent Populates After Execution)

- **Agent Model Used:** `Claude 3.7 Sonnet (via Cursor)`
- **Completion Notes:** Modified `CASE_INITIALIZER_INSTRUCTIONS` in `src/mystery_ai/agents/case_initializer.py` to handle a new JSON input structure. The input now includes the `theme` and an `attribute_options` object containing sub-lists for cause of death, motive (for later use with suspects), occupation, and personality. The victim agent is instructed to select options from relevant lists (excluding motives), thematically integrate these selections into the victim's descriptive fields, and populate new explicit fields. Additionally, `SuspectGenerationAgent` has been updated to receive motive options and select an appropriate motive for each suspect. The orchestrator (`main_orchestrator.py`) was updated to provide the new input structures to both agents. Manual testing will be required to fully verify AC3-AC7 concerning thematic integration quality.
- **Change Log:**
  - Initial Draft
  - Updated agent instructions and orchestrator.
  - Modified implementation to use per-suspect motives instead of a single victim motive.
  - Marked for review. 