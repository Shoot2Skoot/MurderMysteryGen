# Story 5.3: `CaseInitializationAgent` - Integrate Selected Attributes

**Status:** Draft

## Goal & Context

**User Story:** As a Developer, I want to modify the `CaseInitializationAgent` to accept sub-lists of attribute options (Cause of Death, Motive Category, Occupation, Personality), select one from each, and thematically integrate the selected options into the generated `VictimProfile`.

**Context:** Following Story 5.2 where the orchestrator prepares sub-lists of attribute options, this story focuses on enhancing the `CaseInitializationAgent`. The agent must now consume these options, make a selection for each attribute, and most importantly, weave these selected attributes (Cause of Death, Motive, Occupation, Personality) into the victim's profile in a way that is thematically coherent with the overall mystery theme.

## Detailed Requirements

- Update `CaseInitializationAgent`'s input handling to receive the attribute option sub-lists from the orchestrator (as prepared in Story 5.2).
- Modify the agent's internal logic/prompt to first select one item from each provided sub-list (e.g., one Cause of Death from 2-3 options, one Motive Category from 2-3 options, etc.).
- Crucially, update the agent's prompt to ensure it *thematically integrates* the chosen items into the victim's existing `name`, `occupation`, `personality`, and `cause_of_death` fields, rather than just appending them or listing them separately. The overall theme remains paramount in guiding the final descriptions.
- The agent should still output a `VictimProfile` object, now enriched by these thematically integrated, selected attributes.

## Acceptance Criteria (ACs)

- AC1: `CaseInitializationAgent` correctly processes new input parameters containing the sub-lists for Cause of Death options, Motive Category options, Occupation options, and Personality options.
- AC2: The agent's internal logic successfully selects one option from each of the provided sub-lists.
- AC3: The agent's output `VictimProfile.cause_of_death` field thematically reflects the selected Cause of Death option and is consistent with the overall theme.
- AC4: The agent's output `VictimProfile.occupation` field thematically reflects the selected Occupation Archetype option and is consistent with the overall theme.
- AC5: The agent's output `VictimProfile.personality` field thematically reflects the selected Personality Archetype option and is consistent with the overall theme.
- AC6: The agent's output `VictimProfile` (particularly `personality`, implied circumstances, or a new field if added in Story 5.4) thematically reflects the selected Motive Category for the crime *against* the victim, consistent with the overall theme.
- AC7: The integration of all selected attributes appears natural, coherent, and consistent with the overall theme in the final `VictimProfile` output.

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Developer agent is expected to follow project standards in `docs/coding-standards.md` and understand the project structure in `docs/project-structure.md`. Only story-specific details are included below.

- **Relevant Files:**
  - Files to Create: None.
  - Files to Modify:
    - `src/mystery_ai/agents/case_initializer.py` (primarily the agent's instructions/prompt and potentially input handling if it uses a specific input model).

- **Key Technologies:**
  - Python.
  - LLM Prompt Engineering.

- **API Interactions / SDK Usage:**
  - Relies on the existing LLM via the `Agent` SDK. The core work is modifying the prompt/instructions passed to the LLM.

- **UI/UX Notes:**
  - N/A

- **Data Structures:**
  - Input: The dictionary/object prepared by the orchestrator in Story 5.2, containing sub-lists of options (e.g., `{"cause_of_death_options": [...], ...}`).
  - Output: A `VictimProfile` Pydantic model object.

- **Environment Variables:**
  - None specific to this story.

- **Coding Standards Notes:**
  - Follow standards in `docs/coding-standards.md`.
  - The prompt modifications must be very clear in instructing the LLM to *integrate* choices thematically, not just list them. This may require careful wording and examples within the prompt.
  - Consider how the agent will make its selections (e.g., explicitly instruct the LLM to pick one from each list provided in the input).

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests. Follow general testing approach in `docs/testing-strategy.md`.

- **Unit Tests:**
  - If any helper functions are extracted within the agent for processing inputs or structuring outputs, they should be unit tested.
- **Integration Tests:**
  - Test the `CaseInitializationAgent` with various themes and mocked sub-list inputs from the orchestrator.
  - Verify that the output `VictimProfile` contains fields that reflect the *selected* options in a thematically appropriate manner. This will likely involve manual review of generated text.
- **Manual/CLI Verification:**
  - Run the main orchestration (`python -m src.mystery_ai.main --theme "Your Theme"`) and inspect the `VictimProfile` in the final JSON output.
  - Check for thematic coherence of chosen attributes against the theme (AC7).
  - Verify that the chosen attributes influenced the `cause_of_death`, `occupation`, and `personality` fields as expected.
  - Add logging within the agent to show which specific option was selected from each list for easier debugging.

## Tasks / Subtasks

- [ ] Task 1: Update the `CASE_INITIALIZER_INSTRUCTIONS` in `src/mystery_ai/agents/case_initializer.py` to accept new input sections for attribute options (cause of death, motive, occupation, personality).
- [ ] Task 2: Modify the prompt to instruct the LLM to select one option from each provided list.
- [ ] Task 3: Modify the prompt to instruct the LLM to thematically integrate the selected "Cause of Death" into the `VictimProfile.cause_of_death` description.
- [ ] Task 4: Modify the prompt to instruct the LLM to thematically integrate the selected "Occupation Archetype" into the `VictimProfile.occupation` description.
- [ ] Task 5: Modify the prompt to instruct the LLM to thematically integrate the selected "Personality Archetype" into the `VictimProfile.personality` description.
- [ ] Task 6: Modify the prompt to instruct the LLM to ensure the scenario implied by the `VictimProfile` is consistent with the selected "Motive Category" (for the crime against the victim).
- [ ] Task 7: Ensure the agent continues to output a valid `VictimProfile` JSON object.
- [ ] Task 8: Add logging within the agent to record the sub-lists received and the specific item selected from each list.
- [ ] Task 9: Test with at least 3 different themes and various combinations of attribute options to ensure thematic integration and coherence (AC7).
- [ ] Task 10: Verify all Acceptance Criteria are met.

## Story Wrap Up (Agent Populates After Execution)

- **Agent Model Used:** `<Agent Model Name/Version>`
- **Completion Notes:** {Any notes about implementation choices, difficulties, or follow-up needed}
- **Change Log:**
  - Initial Draft 